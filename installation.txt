############
#Basic setup

..in a fresh terminal, navigate to where you want the installation
mkdir ColabFold
cd ColabFold
wget -q -P . https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -p colabfoldconda
rm -f Miniconda3-latest-Linux-x86_64.sh
source colabfoldconda/etc/profile.d/conda.csh
conda create -n colabfold python=3.8 -y
conda activate colabfold
conda update -n base conda -y

############
#Colabfold

pip install "colabfold[alphafold] @ git+https://github.com/sokrypton/ColabFold"

############
#More dependencies

conda install -c conda-forge cudnn==8.2.1.32 cudatoolkit==11.1.1 openmm==7.5.1 pdbfixer

..get the file below from https://storage.googleapis.com/jax-releases/jax_releases.html
pip install jaxlib-0.1.75+cuda11.cudnn82-cp38-none-manylinux2010_x86_64.whl

############
#Alphafold models

..Download the alphafold models "https://storage.googleapis.com/alphafold/alphafold_params_2021-10-27.tar". You need the params_model_X_ptm.npz and params_model_X_multimer.npz.

mkdir colabfoldconda/envs/colabfold/lib/python3.8/site-packages/alphafold/data/params
tar --extract --verbose --file="alphafold_params_2021-10-27.tar" --preserve-permissions --directory="colabfoldconda/envs/colabfold/lib/python3.8/site-packages/alphafold/data/params"

############
#Colabfold fix

..edit colabfoldconda/envs/colabfold/lib/python3.8/site-packages/colabfold/colabfold/plot.py: add these to the very top of the file:
import matplotlib
matplotlib.use('Agg')

############
#HHsearch

..in parent directory
git clone https://github.com/soedinglab/hh-suite.git
mkdir -p hh-suite/build && cd hh-suite/build
cmake -DCMAKE_INSTALL_PREFIX=. ..
make -j 4 && make install

..edit colabfoldconda/envs/colabfold/lib/python3.8/site-packages/colabfold/colabfold/batch.py: the binary_path for hhsearch_pdb70_runner variable should point to "/full/path/to/hh-suite/build/bin/hhsearch"

############
#Amber fixes

..run the command below in parent directory. the file stereo_chemical_props.txt should show up once finished
wget https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt --no-check-certificate

..the files below are in colabfoldconda/envs/colabfold/lib/python3.8/site-packages/colabfold

..edit colabfold/batch.py. The stereo_chemical_props_path should point to "/full/path/to/stereo_chemical_props.txt"
..edit alphafold/common/residue_constants.py. The stereo_chemical_props_path should point to as above
..edit both instances of "CPU" in alphafold/relax/amber_minimize.py to "CUDA" to run amber_relax on GPUs (faster)

############
#Wrapper script

..Edit colabfold.py so that paramsdir points to "/full/path/to/colabfoldconda/envs/colabfold/lib/python3.8/site-packages/alphafold/data"

############
#Run

..Every time you start a new terminal:

source /full/path/to/colabfoldconda/etc/profile.d/conda.csh
conda activate colabfold

..Run colabfold with:

python colabfold.py --sequence="MYSEQUENCE:OTHERSEQUENCE" --jobname="complex3"
